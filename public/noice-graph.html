<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noice graph</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/mathjs@10.6.1/lib/browser/math.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="noicePlotGraph" style="width:100%;max-width:700px"></div>
</body>
<script>
    const domain = (new URL(window.location.href));
    const socket = io(domain.origin);
    
    socket.on("connect", () => {
        socket.emit("purpose", "noice-graph")
    })
</script>
<script>
    class Ticker {
      constructor (name) {

        this.name = name;
        this.data = [
          { x: [0], y: [0], mode: "lines", name, marker: {color: "#ff5959"}},
          { x: [0], y: [0], mode: "lines", name: "upper", marker: {color: "#4dfc3d"}},
          { x: [0], y: [0], mode: "lines", name:"lower",marker:{color: "#4dfc3d"}},
          // { x: [0], y: [0], mode: "lines", name: "average",marker: {color: "#000000"}},
        ]
        this.mean = 0
        this.filterValue = 0
        this.iteration = 0
        this.diviationMultiplier = 2
        this.layout = {
          xaxis: {range: [0, this.iteration + 20], title: this.name},
          yaxis: {range: [-1, 1], title: "degrees per tenth of second"},
          title: "Noice Graph"
        }
      }


      tic ( value ) {
        this.iteration ++
        this.layout.xaxis.range[1] = this.iteration + 20

        this.data[0].x[this.iteration] = this.iteration
        this.data[0].y[this.iteration] = value
        if(this.iteration === 100) this.calcFilter()
        Gx.draw()
      }

      calcFilter () {
        const yData = this.data[0].y

        let sumTotal = 0;

        yData.forEach(value => sumTotal += value)

        this.mean = sumTotal / yData.length
        let standardDiv = 0

        yData.forEach((value) => standardDiv += (value - this.mean)*(value -this.mean))
       
        standardDiv = Math.sqrt(standardDiv / (yData.length - 1))

        this.filterValue = standardDiv * this.diviationMultiplier
      }

     
      draw() {
        Plotly.newPlot("noicePlotGraph", this.data, this.layout)
        this.data[1].x[this.iteration] = this.iteration
        this.data[2].x[this.iteration] = this.iteration

        this.data[1].y[this.iteration] = this.mean + this.filterValue
        this.data[2].y[this.iteration] = this.mean - this.filterValue
      }
    }
    
    const Gx = new Ticker("Gx")

    socket.on("raw-gyro-data", (data) => {
      Gx.tic(data.Gx)
      
    })
    </script>
</html>